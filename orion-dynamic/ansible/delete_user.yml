---
- name: De-provision user from a worker node
  hosts: all
  become: yes
  gather_facts: no
  vars:
    ansible_ssh_common_args: '-o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'

  tasks:
    # Install shadow to ensure userdel/groupdel are robust
    - name: Install shadow package (Alpine)
      ansible.builtin.shell: apk add --no-cache shadow
      ignore_errors: yes

    - name: Get all PIDs for the user
      ansible.builtin.shell: |
        pgrep -u {{ target_user }} || echo ""
      register: user_pids
      ignore_errors: yes

    - name: Kill all user processes
      ansible.builtin.shell: |
        pkill -KILL -u {{ target_user }} || true
      ignore_errors: yes

    - name: Wait for processes to die
      ansible.builtin.pause:
        seconds: 2

    - name: Force remove user (Shell fallback)
      ansible.builtin.shell: |
        userdel -r -f {{ target_user }} || deluser --remove-home {{ target_user }} || true
      register: userdel_result
      ignore_errors: yes

    - name: Ensure the client user is removed (Ansible Module)
      ansible.builtin.user:
        name: "{{ target_user }}"
        state: absent
        remove: yes
        force: yes
      when: userdel_result.rc != 0

    - name: Final cleanup check
      ansible.builtin.shell: |
        rm -rf /home/{{ target_user }}
        rm -rf /var/spool/cron/crontabs/{{ target_user }}
      ignore_errors: yes